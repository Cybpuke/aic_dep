sudo systemctl stop docker
sudo systemctl stop containerd

sudo mkdir -p /mnt/data/containerd
sudo rsync -aHAX --numeric-ids /var/lib/containerd/ /mnt/data/containerd/

# Ensure containerd config exists
if [ ! -f /etc/containerd/config.toml ]; then
  sudo mkdir -p /etc/containerd
  sudo containerd config default | sudo tee /etc/containerd/config.toml >/dev/null
fi

# Set containerd root to /mnt/data/containerd
sudo sed -i 's|^root = .*|root = "/mnt/data/containerd"|' /etc/containerd/config.toml

# Move old dir out of the way (safe rollback)
sudo mv /var/lib/containerd /var/lib/containerd.bak
sudo mkdir -p /var/lib/containerd

sudo systemctl start containerd
sudo systemctl start docker

# Verify
containerd config dump | egrep '^(root|state)'
df -h / /mnt/data
